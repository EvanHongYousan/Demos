<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"/>
    <link href="http://cdn.bootcss.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" rel="stylesheet">
    <script src='jquery.min.js'></script>
    <script src='strophe.min.js'></script>
    <script src="strophe.muc.js"></script>
    <script>
        // XMPP服务器BOSH地址
        var BOSH_SERVICE = 'http://192.168.0.231:5280';

        // 房间JID
        var ROOM_JID = '109@muc.192.168.0.231';

        // XMPP连接
        var connection = null;

        // 当前状态是否连接
        var connected = false;

        // 当前登录的JID
        var jid = "";

        console.log('说明---');
        console.log("   连接失败 Strophe.Status.CONNFAIL：" + Strophe.Status.CONNFAIL);
        console.log("   登录失败 Strophe.Status.AUTHFAIL：" + Strophe.Status.AUTHFAIL);
        console.log("   连接断开 Strophe.Status.DISCONNECTED：" + Strophe.Status.DISCONNECTED);
        console.log("   连接成功 Strophe.Status.CONNECTED：" + Strophe.Status.CONNECTED);
        console.log('-------');

        // 连接状态改变的事件
        function onConnect(status) {
            console.log("当前状态：" + status);
            if (status == Strophe.Status.CONNFAIL) {
                alert("连接失败！");
            } else if (status == Strophe.Status.AUTHFAIL) {
                alert("登录失败！");
            } else if (status == Strophe.Status.DISCONNECTED) {
                alert("连接断开！");
                connected = false;
            } else if (status == Strophe.Status.CONNECTED) {
                alert("连接成功，可以开始聊天了！");
                connected = true;

                // 当接收到<message>节，调用onMessage回调函数
                connection.addHandler(onMessage, null, 'message', null, null, null);

                // 首先要发送一个<presence>给服务器（initial presence）
                connection.send($pres().tree());

                // 发送<presence>元素，加入房间
//                connection.send($pres({
//                    from: connection.jid, //被这地方坑了两天   是 connections.jid，不是jid
//                    to: ROOM_JID + "/" + jid.substring(0, jid.indexOf("@"))
//                }).c('x', {xmlns: 'http://jabber.org/protocol/muc'}).c('password', 123).tree());

                connection.muc.join(ROOM_JID, jid.substring(0, jid.indexOf("@")), null, null, null, '123');

                connection.muc.configure(ROOM_JID, function (data) {
                    connection.muc.saveConfiguration(ROOM_JID, data, function (data_2) {
                        console.log('saveConfigure success');
                    });
                }, function () {
                    console.log('configure error')
                });
            }
        }

        // 接收到<message>
        function onMessage(msg) {

            console.log(msg);
            // 解析出<message>的from、type属性，以及body子元素
            var from = msg.getAttribute('from');
            var type = msg.getAttribute('type');
            var elems = msg.getElementsByTagName('body');

            if (type == "groupchat" && elems.length > 0) {
                var body = elems[0];
                $("#msg").append(from.substring(from.indexOf('/') + 1) + ":<br>" + Strophe.getText(body) + "<br>");
                $("#msg")[0].scrollTop = $("#msg")[0].scrollHeight;
            }
            return true;
        }

        function getReqPrm(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) {
                return unescape(r[2]);
            } else {
                return null;
            }
        }

        $(document).ready(function () {

            // 通过BOSH连接XMPP服务器
            $('#btn-login').click(function () {
                if (!connected) {
                    connection = new Strophe.Connection(BOSH_SERVICE);
                    connection.connect($("#input-jid").val(), $("#input-pwd").val(), onConnect);
                    jid = $("#input-jid").val();
                    $(this).attr('disabled', 'disabled');
                    setTimeout(function () {
                        if (!connected) {
                            $('#btn-login').removeAttr('disabled');
                        }
                    }, 5000);
                }
            });

            // 发送消息
            $("#btn-send").click(function () {
                if (connected) {

                    // 创建一个<message>元素并发送
                    var msg = $msg({
                        to: ROOM_JID,
                        from: jid,
                        type: 'groupchat'
                    }).c("body", $("#input-msg").val());
                    connection.send(msg.tree());

                    $("#input-msg").val('');
                } else {
                    alert("请先登录！");
                }
            });

            $("#btn-mute").click(function () {
                if (connected) {
                    connection.muc.mute(ROOM_JID, $('#input-nickname').val(), '禁言test', function () {
                        alert('禁言成功');
                    }, function () {
                        alert('禁言失败')
                    });
                } else {
                    alert("请先登录！");
                }
            });

            $("#btn-voice").click(function () {
                if (connected) {
                    connection.muc.voice(ROOM_JID, $('#input-nickname').val(), '解禁test', function () {
                        alert('解禁成功');
                    }, function () {
                        alert('解禁失败')
                    });
                } else {
                    alert("请先登录！");
                }
            });

            alert("username:" + getReqPrm('username') + '\npassword:' + getReqPrm('password'));
        });
    </script>
</head>
<body>
<div class="container">
    <form>
        <div class="form-group">
            <label for="">JID：</label>
            <input class="form-control" type="text" id="input-jid" value="15800031161@192.168.0.231">
        </div>
        <div class="form-group">
            <label for="">密码：</label>
            <input class="form-control" type="password" id="input-pwd" value="111111">
        </div>
        <button type="button" class="btn btn-success btn-block" id="btn-login">登录</button>
        <br/>

        <div class="form-group">
            <div class="form-control" id="msg" style="width:100%;height:100px;overflow-y: scroll;"></div>
        </div>
        <div class="form-group">
            <label for="">消息：</label>
            <textarea class="form-control" id="input-msg" cols="30" rows="4"></textarea>
        </div>
        <button type="button" class="btn btn-success btn-block" id="btn-send">发送</button>
        <div class="form-group">
            <label for="">禁言对象昵称：</label>
            <input class="form-control" type="text" id="input-nickname" value="15800031162">
        </div>
        <button type="button" class="btn btn-success btn-block" id="btn-mute">禁言</button>
        <button type="button" class="btn btn-success btn-block" id="btn-voice">解禁</button>
    </form>
</div>
</body>
</html>  
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"/>
    <style>
        html {
            font-family: "Microsoft YaHei";
        }

        html, body {
            padding: 0;
            margin: 0;
        }

        .container {
            padding: 0;
            margin: 0 auto;
            width: 100%;
            max-width: 1000px;
        }

        .container h3 {
            text-align: center;
            color: #5f5f5f;
            margin: 10px auto;
        }

        #msg {
            background-color: #f9f9f9;
            width: 90%;
            height: 500px;
            overflow-y: scroll;
            padding: 5%;
        }

        #msg .teacher .name {
            color: #00c391;
        }

        #msg .teacher .text {
            color: #ff1d23;
        }

        #msg .student .name {
            color: #00b0ff;
        }

        #msg .student .text {
            color: #5f5f5f;
        }

        .container .inputDiv {
            position: relative;
            margin: 0;
            padding: 0;
            border: none;
        }

        #input-msg {
            width: 90%;
            height: 150px;
            margin: 0;
            padding: 5%;
            border: none;
            border-top: 1px solid #2ce6f7;
            border-bottom: 1px solid #2ce6f7;
            font-size: 20px;
        }

        #input-msg:focus {
            outline: none;
        }

        #btn-send {
            border: none;
            padding: 8px 24px;
            color: white;
            background-color: #2bd8ac;
            font-size: 18px;
            border-radius: 5px;
            position: absolute;
            bottom: 17px;
            right: 17px;
            cursor: pointer;
            font-family: "Microsoft YaHei";
        }

        #btn-send:active {
            background-color: #2ee7b8;
        }

        button:focus {
            outline: none;
        }
    </style>
    <script src='jquery.min.js'></script>
    <script src='strophe.min.js'></script>
    <script src="strophe.muc.js"></script>
    <script src="base64.min.js"></script>
    <script src="json3.min.js"></script>
    <script>
        //?param=eyJyb29tX2lkIjoiaGpsYW9zaGkiLCJjb3Vyc2VfaWQiOiI1NzJhZjI5OGIxY2YwMWQzZDQ4YTJhNWMiLCJib3NoX3NlcnZpY2UiOiJodHRwOi8vMTkyLjE2OC4wLjIzMTo1MjgwIiwicm9vbV9wYXNzd29yZCI6IjEyMzQ1NiIsInRlYWNoZXJfYWNjb3VudCI6IjgyMzI0YmE2ZTVmZDQwZDU5MmJmNjIzZTI2ZjU0MzM4IiwicGFzc3dkIjoiMTExMTExIiwidXNlcl9pbmZvIjp7ImZ1bGxfbmFtZSI6Ij8/PyIsInVzZXJfaWQiOiI4MjMyNGJhNmU1ZmQ0MGQ1OTJiZjYyM2UyNmY1NDMzOEAxOTIuMTY4LjAuMjMxIiwiaWRlbnRpdHkiOjEsImxhc3RfbmFtZSI6Ij8ifSwicmVzb3VyY2VzIjoiaHR0cDovL3Rlc3QuaGpsYW9zaGkuY29tL3J0Yy9maWxlLzIwMTYtMDQvdGVzdF9jb3Vyc2UvJUU1JUFEJTk5JUU0JUI4JTlBJUU2JUIwJTkxLnppcCIsInJ0bXBfcHVsbF91cmwiOiJydG1wOi8vdjEubGl2ZS4xMjYubmV0L2xpdmUvMmI2NmRjMTc3MjUzNGY4Y2IwOGM1NDgyMTNhYjQ0Y2IiLCJ0aXRsZSI6Im51bGxudWxsIiwicHJlX2JlZ2luX3RpbWUiOjE0NjI0NDY3ODAwMDB9

        // XMPP服务器BOSH地址
        var BOSH_SERVICE = 'http://192.168.0.231:5280';

        // 房间JID
        var ROOM_JID = '';
        var ROOM_PW = '';

        // XMPP连接
        var connection = null;

        // 当前状态是否连接
        var connected = false;

        // 当前登录的JID与密码
        var jid = "";
        var jpw = "";

//        console.log('说明---');
//        console.log("   连接失败 Strophe.Status.CONNFAIL：" + Strophe.Status.CONNFAIL);
//        console.log("   登录失败 Strophe.Status.AUTHFAIL：" + Strophe.Status.AUTHFAIL);
//        console.log("   连接断开 Strophe.Status.DISCONNECTED：" + Strophe.Status.DISCONNECTED);
//        console.log("   连接成功 Strophe.Status.CONNECTED：" + Strophe.Status.CONNECTED);
//        console.log('-------');

        // 连接状态改变的事件
        function onConnect(status) {
//            console.log("当前状态：" + status);
            if (status == Strophe.Status.CONNFAIL) {
                alert("连接失败！");
            } else if (status == Strophe.Status.AUTHFAIL) {
                alert("登录失败！");
            } else if (status == Strophe.Status.DISCONNECTED) {
                alert("连接断开！");
                connected = false;
            } else if (status == Strophe.Status.CONNECTED) {
                alert("连接成功，可以开始聊天了！");
                connected = true;

                // 当接收到<message>节，调用onMessage回调函数
                connection.addHandler(onMessage, null, 'message', null, null, null);

                // 首先要发送一个<presence>给服务器（initial presence）
                connection.send($pres().tree());

                // 发送<presence>元素，加入房间
//                connection.send($pres({
//                    from: connection.jid, //被这地方坑了两天   是 connections.jid，不是jid
//                    to: ROOM_JID + "/" + jid.substring(0, jid.indexOf("@"))
//                }).c('x', {xmlns: 'http://jabber.org/protocol/muc'}).c('password', 123).tree());

                connection.muc.join(ROOM_JID, jid, null, null, null, ROOM_PW);

                connection.muc.configure(ROOM_JID, function (data) {
                    connection.muc.saveConfiguration(ROOM_JID, data, function (data_2) {
//                        console.log('saveConfigure success');
                    });
                }, function () {
//                    console.log('configure error')
                });
            }
        }

        // 接收到<message>
        function onMessage(msg) {

//            console.log(msg);
            // 解析出<message>的from、type属性，以及body子元素
            var from = msg.getAttribute('from');
            var type = msg.getAttribute('type');
            var elems = msg.getElementsByTagName('body');

            if (type == "groupchat" && elems.length > 0) {
                var body = elems[0];
                var bodyObj = null, pClass = '';
                if (from.indexOf('/') < 0) {
                    $("#msg").append('<p>' + from.substring(from.indexOf('/') + 1) + ":" + Strophe.getText(body) + "</p>");
                    $("#msg")[0].scrollTop = $("#msg")[0].scrollHeight;
                } else {
                    bodyObj = JSON3.parse(Base64.decode(Strophe.getText(body)));
//                    console.log(bodyObj);
                    bodyObj.body.from_user.identity == 1 ? pClass = 'teacher' : pClass = 'student';
                    $("#msg").append('<p class="' + pClass + '"><span class="name">' + bodyObj.body.from_user.full_name + ":</span><span class='text'>" + bodyObj.body.text + "</span></p>");
                    $("#msg")[0].scrollTop = $("#msg")[0].scrollHeight;
                }

            }
            return true;
        }

        function getReqPrm(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) {
                return unescape(r[2]);
            } else {
                return null;
            }
        }

        $(document).ready(function () {
            var param = JSON3.parse(Base64.decode(getReqPrm('param')));

            BOSH_SERVICE = param.bosh_service+':5280';

            if(!/5280/.test(BOSH_SERVICE)){
                BOSH_SERVICE = param.bosh_service+':5280';
            }

            jid = param.user_info.user_id;
            jpw = param.passwd;
            ROOM_JID = param.room_id + '@muc.' + BOSH_SERVICE.replace('http://','').replace(':5280','');
            ROOM_PW = param.room_password;


            if (!connected) {
                connection = new Strophe.Connection(BOSH_SERVICE);
                connection.connect(jid, jpw, onConnect);
            }

            // 发送消息
            $("#btn-send").click(function () {
                if (connected) {
                    var data2send = '';
                    data2send = JSON3.stringify({
                        "header": {
                            "id": "mutil_user_chart_msg"
                        },
                        "body": {
                            "text": $("#input-msg").val(),
                            "from_user": {
                                "identity": param.user_info.identity,
                                "full_name": param.user_info.full_name,
                                "user_id": param.user_info.user_id,
                                "last_name": param.user_info.full_name
                            },
                            "type": "1"
                        }
                    });
                    data2send = Base64.encode(data2send);
                    connection.muc.groupchat(ROOM_JID, data2send);
                    $("#input-msg").val('');
                } else {
                    alert("请先登录！");
                }
            });
/*禁言部分 start*/
//            $("#btn-mute").click(function () {
//                if (connected) {
//                    connection.muc.mute(ROOM_JID, $('#input-nickname').val(), '禁言test', function () {
//                        alert('禁言成功');
//                    }, function () {
//                        alert('禁言失败');
//                    });
//                } else {
//                    alert("请先登录！");
//                }
//            });
//
//            $("#btn-voice").click(function () {
//                if (connected) {
//                    connection.muc.voice(ROOM_JID, $('#input-nickname').val(), '解禁test', function () {
//                        alert('解禁成功');
//                    }, function () {
//                        alert('解禁失败');
//                    });
//                } else {
//                    alert("请先登录！");
//                }
//            });

//            alert("username:" + getReqPrm('username') + '\npassword:' + getReqPrm('password'));
/*end*/
        });
    </script>
</head>
<body>
<div class="container">
    <h3>课堂问答</h3>
    <div id="msg"></div>
    <div class="inputDiv">
        <textarea id="input-msg"></textarea>
        <button type="button" id="btn-send">发&nbsp;&nbsp;&nbsp;送</button>
    </div>
    <p style="text-align: center;font-size:12px;color:#5f5f5f;">©2016呼叫老师</p>


    <!--<label style="margin-top:300px;display:block;" for="">JID：</label>-->
    <!--<input type="text" id="input-jid" value="18700000015@test.hjlaoshi.com">-->
    <!--<label for="">密码：</label>-->
    <!--<input type="password" id="input-pwd" value="123456">-->
    <!--<button type="button" id="btn-login">登录</button>-->
    <!--<br/>-->
    <!--<label for="">禁言对象昵称：</label>-->
    <!--<input type="text" id="input-nickname" value="15800031162">-->
    <!--<button type="button" id="btn-mute">禁言</button>-->
    <!--<button type="button" id="btn-voice">解禁</button>-->
</div>
</body>
</html>